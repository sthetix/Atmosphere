name: Build Atmosphere

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64:latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Mark repository as safe for git
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: Install additional packages
      run: |
        # Skip sync due to server issues, install from local cache
        dkp-pacman -S --noconfirm switch-dev switch-glm switch-libjpeg-turbo devkitARM devkitarm-rules python python-pip 2>/dev/null || true
    
    - name: Install Python dependencies
      run: |
        python3 -m pip install --break-system-packages lz4 pycryptodome 2>/dev/null || python -m pip install lz4 pycryptodome || true
    
    - name: Verify environment
      run: |
        echo "DEVKITPRO=$DEVKITPRO"
        echo "DEVKITARM=$DEVKITARM"
        echo "DEVKITA64=$DEVKITA64"
        ls -la $DEVKITPRO/ || true
    
    - name: Build Atmosphere (Release)
      run: make nx_release
    
    - name: Build distribution package
      run: make dist-no-debug
    
    - name: Get Atmosphere version
      id: get_version
      run: |
        VERSION_MAJOR=$(grep 'define ATMOSPHERE_RELEASE_VERSION_MAJOR' libraries/libvapours/include/vapours/ams/ams_api_version.h | tr -s [:blank:] | cut -d' ' -f3)
        VERSION_MINOR=$(grep 'define ATMOSPHERE_RELEASE_VERSION_MINOR' libraries/libvapours/include/vapours/ams/ams_api_version.h | tr -s [:blank:] | cut -d' ' -f3)
        VERSION_MICRO=$(grep 'define ATMOSPHERE_RELEASE_VERSION_MICRO' libraries/libvapours/include/vapours/ams/ams_api_version.h | tr -s [:blank:] | cut -d' ' -f3)
        GIT_REV=$(git rev-parse --short HEAD)
        VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MICRO}-${GIT_REV}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Atmosphere Version: ${VERSION}"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: atmosphere-${{ steps.get_version.outputs.version }}
        path: |
          out/atmosphere-*.zip
          out/fusee.bin
        retention-days: 30
        if-no-files-found: error
    
    - name: Upload individual components (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: atmosphere-components-${{ steps.get_version.outputs.version }}
        path: |
          fusee/out/fusee.bin
          fusee/out/package3
        retention-days: 7
        if-no-files-found: warn
